---
title: "08_analysis_4"
format: html
---

# Loading libraries

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(pheatmap)
library(broom)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(stats)
```

# Preparing dataset

## Removing NA values for "Countries"

From the augmented data, we'll remove the genomes without country information.

```{r}
#| echo: false
#| eval: true

genomes_country <- genome_metadata_aug %>%
  filter(!is.na(Country))
```

# Functions

## Function for preparing data and normalizing it based on the dataset size

Defining a function to:

-   Count the instances of each group per country.

-   Normalize this count based on the sample size of that country.

-   And convert the data into wide format for easier analysis.

```{r}
#| echo: false
#| eval: true

normalize <- function(data, tree_group){
  
  group_freq <- genomes_country %>%
    group_by(Country, .data[[tree_group]]) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(genomes_country %>%
                count(Country, name = "n_samples")) %>%
    mutate(freq_norm = count / n_samples) %>%
    select(Country, .data[[tree_group]], freq_norm) %>%
    pivot_wider(names_from = .data[[tree_group]],
                values_from = freq_norm,
                values_fill = 0)
}
```

# Heatmap

Defining a function to produce the heatmap based on a group in the lineage. First, the data is normalized by sample size for each country; then it is converted into a matrix, and columns with zero variance are removed. The function then produces a heatmap using the pheatmap function.

```{r}
#| echo: false
#| eval: true

heatmap_abundance_per_country <- function(tree_group){
  
  if (!tree_group %in% names(genomes_country)) {
    stop(paste("Column", tree_group, "not found in genomes_country"))
  }
  
  group_freq <- normalize(data = genomes_country,
                          tree_group = tree_group)
  
  group_freq_mat <- group_freq |>
    column_to_rownames("Country") |> 
    as.matrix()
  
  group_freq_mat <- group_freq_mat[, apply(group_freq_mat, 2, sd) > 0, drop = FALSE]
  
  pheatmap::pheatmap(
    mat = group_freq_mat,
    cluster_cols = TRUE,
    scale = "none",
    main = paste0(tree_group, " frequency per country (normalized)")
  )
}

```

Using the function to produce heatmap for the lineage groups Family, Order, and Phylum to ensure clearer plots.

```{r}
#| echo: false
#| eval: true

heatmap_family <- heatmap_abundance_per_country(tree_group = "Family")
heatmap_order <- heatmap_abundance_per_country(tree_group = "Order")
heatmap_phylum <- heatmap_abundance_per_country(tree_group = "Phylum")
```

## Saving results

The resulting heatmaps are saved as png's to the results directory with appropriate sizes.

```{r}
#| echo: false
#| eval: true

ggsave(
  filename = "../results/Heatmap_family.png",
  plot = heatmap_family,
  width = 190,
  height = 100,
  units = "mm",
  dpi = 300
)
ggsave(
  filename = "../results/Heatmap_order.png",
  plot = heatmap_order,
  width = 190,
  height = 100,
  units = "mm",
  dpi = 300
)
ggsave(
  filename = "../results/Heatmap_phylum.png",
  plot = heatmap_phylum,
  width = 190,
  height = 100,
  units = "mm",
  dpi = 300
)
```

# Principal Component Analysis

To investigate if there is a difference in the distribution of microbiomes between countries, a Prinicipal Component Analysis was carried out using the following function. To do this, the data was normalized based on the sample size for each country, after which it was analysed with the prcomp() function. From this fit, the results were extracted (eigenvalues and rotation matrix) and used to create a biplot of the loadings (p1) and determine the variance explained (plotted in p2). Both plots were saved to the results directory.

```{r}
#| echo: false
#| eval: true

PCA_abundance_per_country <- function(tree_group) {

  group_freq <- normalize(data = genomes_country,
                          tree_group = tree_group)

  country_names <- group_freq$Country
  
  pca_fit <- group_freq |> 
    select(-Country) |> 
    scale() |> 
    stats::prcomp()
  
  variance_explained <- pca_fit |> 
    tidy(matrix = "eigenvalues")

  rotation_matrix <- pca_fit |> 
    tidy(matrix = "rotation")

  pca_scores <- pca_fit |> 
    augment(group_freq |> 
              select(-Country)) |> 
    mutate(Country = country_names)
  
  pc1_var <- round(variance_explained$percent[1] * 100, 1)
  pc2_var <- round(variance_explained$percent[2] * 100, 1)
  
  loadings_biplot <- rotation_matrix |> 
    filter(PC %in% c(1, 2)) |> 
    pivot_wider(names_from = PC,
                values_from = value,
                names_prefix = "PC") |> 
    mutate(
      PC1 = PC1 * 3,
      PC2 = PC2 * 3)
  
  
  p1 <- ggplot() +
    geom_point(data = pca_scores, 
               aes(x = .fittedPC1, y = .fittedPC2, color = Country), 
               size = 4,
               show.legend = TRUE) +
    geom_text(data = pca_scores, 
              aes(x = .fittedPC1, y = .fittedPC2, label = Country, color = Country),
              vjust = -1,
              size = 4,
              show.legend = FALSE) +
    geom_segment(data = loadings_biplot,
                 aes(x = 0, y = 0, xend = PC1, yend = PC2),
                 arrow = arrow(length = unit(0.3, "cm")),
                 color = "gray50",
                 linewidth = 0.7) +
    geom_text_repel(data = loadings_biplot,
                    aes(x = PC1, y = PC2, label = column),
                    color = "gray10",
                    size = 3.5,
                    fontface = "italic",
                    box.padding = 0.5,
                    point.padding = 0.3,
                    segment.color = "gray60",
                    segment.size = 0.3,
                    max.overlaps = Inf) +
    labs(title = paste0("PCA Biplot: Countries + ", tree_group),
         x = paste0("PC1 (", pc1_var, "%)"),
         y = paste0("PC2 (", pc2_var, "%)")) +
    theme(legend.position = "right",
          plot.title = element_text(face = "bold"))


  p2 <- ggplot(variance_explained, aes(x = PC, y = percent)) +
    geom_col(fill = "steelblue", alpha = 0.8) +
    scale_y_continuous(labels = scales::percent_format()) +
    labs(title = "Variance Explained by Each PC",
         x = "Principal Component",
         y = "Variance Explained (%)") +
    theme(plot.title = element_text(face = "bold")
          )
  

  ggsave(filename = "../results/PCA_biplot.png",
       plot = p1,
       width = 250,
       height = 160,
       units = "mm")
    
  ggsave(filename = "../results/PCA_variance_explained.png",
         plot = p2,
         width = 110,
         height = 90,
         units = "mm")
  
}

```

Running the function for Phylum, which has fewer variables, hence resulting in a clearer plot.

```{r}
#| echo: false
#| eval: true

PCA_abundance_per_country(tree_group = "Phylum")

```

## 

# Tests: Species' distribution between counties

Simply counting the species (or another tree_group) per country.

```{r}
#| echo: false
#| eval: true

counting_species <- function(data, tree_group){
  data |> 
  group_by(Country, .data[[tree_group]]) |>
  summarise(count = n(), .groups = "drop") |> 
  pivot_wider(names_from = .data[[tree_group]],
              values_from = count,
              values_fill = 0)
}

```

## Chi-squared test, with permutation.

Test if the distribution of species differs between countries. We use simulate.p.value = TRUE to compute the p-value via Monte Carlo simulation, which is more reliable when some expected counts are small or zero.

### For Species

```{r}
#| echo: false
#| eval: true

data <- counting_species(data = genomes_country, tree_group = "Species")

tbl <- as.matrix(data[ , -1])
rownames(tbl) <- data$Country

chisq.test(tbl, simulate.p.value = TRUE, B = 1e6)

```

The difference in distribution of species between countries is not significant at all, as the p-value is 1.

### For Family

```{r}
#| echo: false
#| eval: true

data <- counting_species(data = genomes_country,
                         tree_group = "Family")

tbl <- as.matrix(data[ , -1])
rownames(tbl) <- data$Country

chisq.test(tbl, simulate.p.value = TRUE, B = 1e6)

```

The difference in distribution of species between countries is not significant at all, as the p-value is 0.8.

### For Phylum

```{r}
#| echo: false
#| eval: true

data <- counting_species(data = genomes_country,
                         tree_group = "Phylum")

tbl <- as.matrix(data[ , -1])
rownames(tbl) <- data$Country

chisq.test(tbl, simulate.p.value = TRUE, B = 1e6)

```

The difference in distribution of species between countries is not significant, as the p-value is 0.6

# Endometriosis chi-square test

To assess whether

Check that the data contains the variable of interest:

```{r}
#| echo: false
#| eval: true

names(genomes_country)
```

Creating a table that contains the information about the country and the endometriosis association:

```{r}
#| echo: false
#| eval: true

tab <- table(
  Country = genomes_country$Country,
  Endometriosis = genomes_country$endometriosis_associated
)
tab
prop.table(tab, margin = 1)
```

Performing a chi-square test to see

```{r}
#| echo: false
#| eval: true

chi_res <- chisq.test(tab)

chi_res
chi_res$expected  # expected counts under H0

```

```{r}
#| echo: false
#| eval: true

fisher_res <- fisher.test(tab)

fisher_res

```

```{r}
#| echo: false
#| eval: true

pairwise.prop.test(
  x = table(genomes_country$Country, genomes_country$endometriosis_associated),
  p.adjust.method = "holm"
)


```

```{r}
#| echo: false
#| eval: true

countries <- c("USA", "China")

tab <- table(
  genomes_country$Country[genomes_country$Country %in% countries],
  genomes_country$endometriosis_associated[genomes_country$Country %in% countries]
)

tab
fisher.test(tab)

```

```{r}
#| echo: false
#| eval: true

countries <- c("USA", "Denmark")

tab <- table(
  genomes_country$Country[genomes_country$Country %in% countries],
  genomes_country$endometriosis_associated[genomes_country$Country %in% countries]
)

fisher.test(tab)
```

```{r}
#| echo: false
#| eval: true

countries <- c("Denmark", "China")

tab <- table(
  genomes_country$Country[genomes_country$Country %in% countries],
  genomes_country$endometriosis_associated[genomes_country$Country %in% countries]
)

fisher.test(tab)
```
